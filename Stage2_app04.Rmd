---
title: 'Appendix 4: Mixed-effect models of match advantages'
#tags: `PSA002`
output: html_document
#header-includes:
#  - \usepackage{caption}
#  - \usepackage{float}
#  - \captionsetup[table]{name=Table S,labelsep = period}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(lme4)
library(lmerTest)
library(ggplot2)
library(sjPlot)

# Import multiple-bytes string in English system
Sys.setlocale("LC_ALL","English") 
```

```{r SP-lme-data, message=FALSE, warning=FALSE, include=FALSE}
# import data file for the making of appendix
SP_V_lme_data <- dir(#path = "..",
      pattern = "SP_V_lme_data.csv",   ## include in-site and internet data
      recursive = TRUE, full.names = TRUE) %>% 
      read_csv() %>%
     filter(Outlier == FALSE) %>%  ## excluded outliers by MAD
  filter(Acc_bound == FALSE) %>% # remove people who were less than 70% so they don't match with join
  mutate(Match = factor(Match,
                        levels = c("Y","N"),
                        labels = c("MATCHING","MISMATCHING")),
                        Source = factor(Source, 
                        levels = c("site","osweb"),
                        labels = c("Site","Internet") ))

```


We evaluated the interaction of match advantage and data sources between three models. Based on the recommended practices(Barr et al., 2013; Brauer & Curtin, 2018), the models used the optimizer `bobyqa`. The final report decided `german.two.model` the best fitted model.

### Model included data source

The preregistered plan had not consider the data sources. We conducted this model evaluate the difference between the data sources. 

```{r SP-source-lme, echo=FALSE, message=FALSE, warning=FALSE}
## analysis to decide if we had to analyze on-site and web-based respectively

#SP_V_lme_data$r_Source = if_else(SP_V_lme_data$Source == "Site",1,0)


source_cor.lmer <- lmerTest::lmer(
  response_time ~ Match*r_Source + 
    (1|Subject) + 
    (r_Source|PSA_ID) + 
    (r_Source|Language), 
  control = lmerControl(optimizer = "bobyqa",
                        optCtrl = list(maxfun = 1e6)), 
  data = SP_V_lme_data)


tab_model(source_cor.lmer, title="Coefficents")
```



### Planned analysis: Matching was the only one independent variable

1. The null-effect models.


```{r SP-lang-lme, message=FALSE, warning=FALSE}


## Check the fittest model

#only intercept
intercept.model <- lm(response_time ~ 1, 
                      data = SP_V_lme_data)
#add random intercept of subject
subject.model <- lmer(response_time ~ 1 + (1|Subject), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = SP_V_lme_data)
# add random intercept of item
item.model <- lmer(response_time ~ 1 + (1|Subject) + (1|Target), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = SP_V_lme_data)
# add random intercept of lab
lab.model <- lmer(response_time ~ 1 + (1|Subject) + (1|Target) + (1|PSA_ID), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = SP_V_lme_data)

# add random intercept of language
language.model <- lmer(response_time ~ 1 + (1|Subject) + (1|Target) + (1|PSA_ID) + (1|Language), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = SP_V_lme_data)

tab_model(intercept.model, title = "Model had intercept only.")
tab_model(subject.model, title = "Model had random intercept of participant.")
tab_model(item.model, title = "Model had random intercepts of participant and item.")
tab_model(lab.model, title = "Model had random intercepts of participant, item, and laboratory.")
tab_model(language.model, title = "Model had random intercepts of participant, item, laboratory, and language.")
```


2. The models have match advantage as the fixed effect.


```{r SP_effect01_lme, message=FALSE, warning=FALSE, results='asis'}
SP_one_random.lmer = lmer(response_time ~ Match + (1|Subject), data = SP_V_lme_data) ## build mixed-effects regression

SP_two_random.lmer = lmer(response_time ~ Match + (1|Subject) + (1|Target), data = SP_V_lme_data) ## build mixed-effects regression

SP_three_random.lmer = lmer(response_time ~ Match + (1|Subject) + (1|Target) + (1|PSA_ID), data = SP_V_lme_data) ## build mixed-effects regression

SP_all_random.lmer = lmer(response_time ~ Match + (1|Subject) + (1|Target) + (1|PSA_ID) + (1|Language), data = SP_V_lme_data) ## build mixed-effects regression

tab_model(SP_one_random.lmer, title = "Model had a fixed effect and random intercept of participant.")
tab_model(SP_two_random.lmer, title = "Model had a fixed effect and  random intercepts of participant and item.")
tab_model(SP_three_random.lmer, title = "Model had a fixed effect and random intercepts of participant, item, and laboratory.")
tab_model(SP_all_random.lmer, title = "Model had a fixed effect and random intercepts of participant, item, laboratory, and language.")
```

3. The model had the match condition on the random slope of Language. 

```{r SP_effect02_lme, message=FALSE, warning=FALSE}
#fixed.model <- lmer(response_time ~ Match + (1|Subject) + (1|Target) + (1|PSA_ID) + (1|Language) , 
#                      control = lmerControl(optimizer = "bobyqa",
#                                            optCtrl = list(maxfun = 1e6)), 
#                     data = SP_V_lme_data)

fixed.randomslope.model <- lmer(response_time ~ Match + (1|Subject) + (1|Target) +(1|PSA_ID) + (1|PSA_ID) + (1 + Match|Language), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = SP_V_lme_data)

#tab_model(fixed.model, title="No random slope of match condition")

tab_model(fixed.randomslope.model, title="Add random slope of match condition")
```



### Models for specific languages 

<!---
#### English


We evaluated the interaction of match advantage and English dialects in three models. Based on the recommended practices(Barr et al., 2013; Brauer & Curtin, 2018), the models used the optimizer `bobyqa`. The final report decided `eng_no_slope.lmer` the best fitted model.

--->

```{r SP_English_lme, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
SP_V_eng_tidy <- SP_V_lme_data %>%
  filter(Language == "English")

SP_V_eng_tidy$r_System <- if_else(
  grepl("PSA|USA", SP_V_eng_tidy$PSA_ID),
  1, 0)

eng_no_slope00.lmer = lmerTest::lmer(response_time ~ Match*r_System + (1|Subject), control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6)),  data = SP_V_eng_tidy)

eng_no_slope01.lmer = lmerTest::lmer(response_time ~ Match*r_System + (1|Subject) + (1|Target), control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6)),  data = SP_V_eng_tidy)

eng_no_slope.lmer = lmerTest::lmer(response_time ~ Match*r_System + (1|Subject) + (1|Target) + (1|PSA_ID), control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6)),  data = SP_V_eng_tidy)


tab_model(eng_no_slope00.lmer, title = "Model have random intercept of participant")  
tab_model(eng_no_slope01.lmer, title = "Model have random intercepts of participant and item")
tab_model(eng_no_slope.lmer, title = "Model have random intercept of participant, item, and laboratories")
```


#### German


```{r SP_Germany_lme, message=FALSE, warning=FALSE, cache=TRUE}
#null-effect model without random intercepts
german.intercept.model <- lm(response_time ~ 1, 
                      data = subset(SP_V_lme_data,Language == "German"))
#add random intercept of subject
german.subject.model <- lmer(response_time ~ 1 + (1|Subject), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = subset(SP_V_lme_data,Language == "German"))
# add random intercept of item
german.item.model <- lmer(response_time ~ 1 + (1|Subject) + (1|Target), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = subset(SP_V_lme_data,Language == "German"))
# add random intercept of lab
german.lab.model <- lmer(response_time ~ 1 + (1|Subject) + (1|Target) + (1|PSA_ID), 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = subset(SP_V_lme_data,Language == "German"))


german.two.model <- lmer(response_time ~ Match + (1|Subject) + (1|Target) , 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = subset(SP_V_lme_data,Language == "German"))


german.three.model <- lmer(response_time ~ Match + (1|Subject) + (1|Target) + (1|PSA_ID) , 
                      control = lmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1e6)), 
                      data = subset(SP_V_lme_data,Language == "German"))

tab_model(german.intercept.model, title= "Null-effect model without random intercepts")
tab_model(german.subject.model, title= "Null-effect model with random intercept of participants")
tab_model(german.item.model, title= "Null-effect model with random intercepts of participants and items")
tab_model(german.lab.model, title= "Null-effect model with random intercepts of participants, items, and teams")

tab_model(german.two.model, title="Model with the fixed effect of match condition and random intercepts of participants and items.")
tab_model(german.three.model, title = "Model with the fixed effect of match condition and random intercepts of participants, items, and teams.")
```